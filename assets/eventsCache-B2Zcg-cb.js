import{aQ as p,aa as T,Y as A,as as b,aR as I,aS as F,ab as H,X as R,au as M}from"./index-DvtLfIyG.js";const v="t2t_economic_events_cache",S="t2t_events_cache_metadata",x="1.0.0",L=24;function D(e="forex-factory"){try{const t=`${S}_${e}`,a=localStorage.getItem(t);if(!a)return null;const o=JSON.parse(a);return o.version!==x?(console.log("ğŸ“¦ Cache version mismatch, invalidating..."),K(e),null):o}catch(t){return console.error("âŒ Error reading cache metadata:",t),null}}function _(e="forex-factory"){try{const t=`${v}_${e}`,a=localStorage.getItem(t);return a?JSON.parse(a):null}catch(t){return console.error("âŒ Error reading cached events:",t),null}}function K(e=null){e?(console.log(`ğŸ—‘ï¸ Invalidating events cache for source: ${e}`),localStorage.removeItem(`${v}_${e}`),localStorage.removeItem(`${S}_${e}`)):(console.log("ğŸ—‘ï¸ Invalidating all events caches"),["forex-factory","mql5","fxstreet"].forEach(a=>{localStorage.removeItem(`${v}_${a}`),localStorage.removeItem(`${S}_${a}`)}),localStorage.removeItem(v),localStorage.removeItem(S))}async function N(e="forex-factory"){const t=D(e);if(!t)return!1;const o=Date.now()-t.cachedAt,r=L*60*60*1e3;if(o>r)return console.log("â° Cache expired (age-based)"),!1;const f=new Date,l=new Date(f);l.setDate(l.getDate()-14),l.setHours(0,0,0,0);const i=new Date(f);i.setDate(i.getDate()+8),i.setHours(23,59,59,999);const g=_(e);if(!g||g.length===0)return console.log("âš ï¸ Cache invalid: no cached events found"),!1;const c=g.map(s=>s.date).sort((s,n)=>s-n),d=c[0],u=c[c.length-1],y=l.getTime(),h=i.getTime();console.log("ğŸ“… [isCacheValid] Checking date range coverage:",{expectedStart:new Date(y).toISOString(),expectedEnd:new Date(h).toISOString(),cachedStart:new Date(d).toISOString(),cachedEnd:new Date(u).toISOString()});const m=Math.abs(d-y)/(1e3*60*60*24),C=Math.abs(u-h)/(1e3*60*60*24);if(m>3||C>3)return console.log(`âš ï¸ Cache date range outdated: startDiff=${m.toFixed(1)}d, endDiff=${C.toFixed(1)}d`),!1;try{const s=await O();return s&&s>t.lastSyncAt?(console.log("ğŸ”„ API sync occurred after cache, invalidating"),!1):!0}catch(s){return console.error("âŒ Error checking sync status:",s),o<=r}}async function O(){try{const e=R(A,"systemJobs","economicEventsCalendarSync"),t=await M(e);if(!t.exists())return null;const o=t.data().lastRun;return o?o.toMillis?o.toMillis():o.seconds*1e3:null}catch(e){return e.code==="permission-denied"?(console.log("âš ï¸ Cannot read sync status (not authenticated), using cache age fallback"),null):(console.error("âŒ Error fetching sync status:",e),null)}}async function k(e="forex-factory"){console.log(`ğŸ“¡ Fetching recent events from source: ${e} (14d back + 8d forward)...`);try{const t=new Date;console.log(`ğŸ“… [eventsCache] Current date/time: ${t.toISOString()} (${t.toLocaleString()})`);const a=new Date(t.getTime());a.setDate(a.getDate()-14),a.setHours(0,0,0,0);const o=new Date(t.getTime());o.setDate(o.getDate()+8),o.setHours(23,59,59,999),console.log(`ğŸ“… [eventsCache] Fetching range: ${a.toISOString()} to ${o.toISOString()}`),console.log(`ğŸ“… [eventsCache] Date range in local time: ${a.toLocaleString()} to ${o.toLocaleString()}`);const r=p.fromDate(a),f=p.fromDate(o),l=T(A,"economicEvents",e,"events"),i=b(l,I("date",">=",r),I("date","<=",f),F("date","asc")),g=await H(i),c=[],d=new Set,u=new Set;g.docs.forEach(s=>{var w,E;const n=s.data();n.currency&&d.add(n.currency),n.category&&u.add(n.category),c.push({id:s.id,name:n.name||n.Name,currency:n.currency||n.Currency,category:n.category||n.Category,date:(w=n.date)!=null&&w.toMillis?n.date.toMillis():((E=n.date)==null?void 0:E.seconds)*1e3||0,actual:n.actual??n.Actual??null,forecast:n.forecast??n.Forecast??null,previous:n.previous??n.Previous??null,outcome:n.outcome||n.Outcome||"",strength:n.strength||n.Strength||"",quality:n.quality||n.Quality||"",projection:n.projection??n.Projection??null,source:e})});const y=`${v}_${e}`;localStorage.setItem(y,JSON.stringify(c));const h=await O()||Date.now(),m={version:x,cachedAt:Date.now(),lastSyncAt:h,eventCount:c.length,currencies:Array.from(d).sort(),categories:Array.from(u).sort(),source:e},C=`${S}_${e}`;return localStorage.setItem(C,JSON.stringify(m)),console.log(`âœ… Cached ${c.length} events from ${e} (14d back + 8d forward)`),c}catch(t){return console.error(`âŒ Error fetching events from ${e}:`,t),[]}}async function $(e=!1,t="forex-factory"){if(console.log(`ğŸ“Š [getAllEvents] Called for source: ${t} (forceRefresh: ${e})`),!e&&await N(t)){const a=_(t);if(a)return console.log(`âœ… [getAllEvents] Using cached events from ${t} (${a.length} events)`),a}return console.log(`ğŸ”„ [getAllEvents] Cache invalid or forceRefresh, fetching from Firestore for ${t}`),await k(t)}async function J(e={}){const t=e.source||"forex-factory",a=await $(!1,t);console.log(`ğŸ” [eventsCache] Filtering ${a.length} cached events from ${t}...`);const{startDate:o,endDate:r,currencies:f=[],categories:l=[],impacts:i=[]}=e;console.log("ğŸ” [eventsCache] Date range:",{startDate:o?new Date(o).toISOString():"none",endDate:r?new Date(r).toISOString():"none",startMs:o?o.getTime():null,endMs:r?r.getTime():null});const g=a.filter(c=>{var d;if(o&&c.date<o.getTime()||r&&c.date>r.getTime()||f.length>0&&!f.includes(c.currency)||l.length>0&&!l.includes(c.category))return!1;if(i.length>0){const u=((d=c.strength)==null?void 0:d.toLowerCase())||"";if(!i.some(h=>{const m=h.toLowerCase();return u.includes(m)}))return!1}return!0});return console.log(`âœ… [eventsCache] Filtered to ${g.length} events`),console.log("ğŸ“Š [eventsCache] Sample filtered event:",g[0]),g}async function P(e="forex-factory"){const t=D(e);if(t&&t.currencies)return t.currencies;await $(!1,e);const a=D(e);return(a==null?void 0:a.currencies)||[]}async function Y(e="forex-factory"){const t=D(e);if(t&&t.categories)return t.categories;await $(!1,e);const a=D(e);return(a==null?void 0:a.categories)||[]}export{$ as getAllEvents,Y as getCachedCategories,P as getCachedCurrencies,J as getFilteredEvents,K as invalidateCache};
