import{aO as $,ah as O,aa as A,aj as T,aP as p,aQ as H,ak as R,a9 as b,ap as K}from"./index-C6QdW-VK.js";const i="t2t_economic_events_cache",u="t2t_events_cache_metadata",_="1.0.0",N=24;function f(e="forex-factory"){try{const t=`${u}_${e}`,a=localStorage.getItem(t);if(!a)return null;const n=JSON.parse(a);return n.version!==_?(console.log("ğŸ“¦ Cache version mismatch, invalidating..."),q(e),null):n}catch(t){return console.error("âŒ Error reading cache metadata:",t),null}}function k(e="forex-factory"){try{const t=`${i}_${e}`,a=localStorage.getItem(t);return a?JSON.parse(a):null}catch(t){return console.error("âŒ Error reading cached events:",t),null}}function q(e=null){e?(console.log(`ğŸ—‘ï¸ Invalidating events cache for source: ${e}`),localStorage.removeItem(`${i}_${e}`),localStorage.removeItem(`${u}_${e}`)):(console.log("ğŸ—‘ï¸ Invalidating all events caches"),["forex-factory","mql5","fxstreet"].forEach(a=>{localStorage.removeItem(`${i}_${a}`),localStorage.removeItem(`${u}_${a}`)}),localStorage.removeItem(i),localStorage.removeItem(u))}async function J(e="forex-factory"){const t=f(e);if(!t)return!1;const n=Date.now()-t.cachedAt,s=N*60*60*1e3;if(n>s)return console.log("â° Cache expired (age-based)"),!1;try{const c=await D();return c&&c>t.lastSyncAt?(console.log("ğŸ”„ API sync occurred after cache, invalidating"),!1):!0}catch(c){return console.error("âŒ Error checking sync status:",c),n<=s}}async function D(){try{const e=b(A,"systemJobs","economicEventsCalendarSync"),t=await K(e);if(!t.exists())return null;const n=t.data().lastRun;return n?n.toMillis?n.toMillis():n.seconds*1e3:null}catch(e){return e.code==="permission-denied"?(console.log("âš ï¸ Cannot read sync status (not authenticated), using cache age fallback"),null):(console.error("âŒ Error fetching sync status:",e),null)}}async function P(e="forex-factory"){console.log(`ğŸ“¡ Fetching recent events from source: ${e} (14d back + 8d forward)...`);try{const t=new Date,a=new Date(t);a.setDate(a.getDate()-14),a.setHours(0,0,0,0);const n=new Date(t);n.setDate(n.getDate()+8),n.setHours(23,59,59,999);const s=$.fromDate(a),c=$.fromDate(n),g=O(A,"economicEvents",e,"events"),d=T(g,p("date",">=",s),p("date","<=",c),H("date","asc")),l=await R(d),o=[],m=new Set,h=new Set;l.docs.forEach(w=>{var S,E;const r=w.data();r.currency&&m.add(r.currency),r.category&&h.add(r.category),o.push({id:w.id,name:r.name||r.Name,currency:r.currency||r.Currency,category:r.category||r.Category,date:(S=r.date)!=null&&S.toMillis?r.date.toMillis():((E=r.date)==null?void 0:E.seconds)*1e3||0,actual:r.actual??r.Actual??null,forecast:r.forecast??r.Forecast??null,previous:r.previous??r.Previous??null,outcome:r.outcome||r.Outcome||"",strength:r.strength||r.Strength||"",quality:r.quality||r.Quality||"",projection:r.projection??r.Projection??null,source:e})});const y=`${i}_${e}`;localStorage.setItem(y,JSON.stringify(o));const v=await D()||Date.now(),I={version:_,cachedAt:Date.now(),lastSyncAt:v,eventCount:o.length,currencies:Array.from(m).sort(),categories:Array.from(h).sort(),source:e},x=`${u}_${e}`;return localStorage.setItem(x,JSON.stringify(I)),console.log(`âœ… Cached ${o.length} events from ${e} (14d back + 8d forward)`),o}catch(t){return console.error(`âŒ Error fetching events from ${e}:`,t),[]}}async function C(e=!1,t="forex-factory"){if(!e&&await J(t)){const a=k(t);if(a)return console.log(`ğŸ“¦ Using cached events from ${t} (${a.length} events)`),a}return await P(t)}async function L(e={}){const t=e.source||"forex-factory",a=await C(!1,t),{startDate:n,endDate:s,currencies:c=[],categories:g=[],impacts:d=[]}=e;return a.filter(l=>{var o;if(n&&l.date<n.getTime()||s&&l.date>s.getTime()||c.length>0&&!c.includes(l.currency)||g.length>0&&!g.includes(l.category))return!1;if(d.length>0){const m=((o=l.strength)==null?void 0:o.toLowerCase())||"";if(!d.some(y=>{const v=y.toLowerCase();return m.includes(v)}))return!1}return!0})}async function M(e="forex-factory"){const t=f(e);if(t&&t.currencies)return t.currencies;await C(!1,e);const a=f(e);return(a==null?void 0:a.currencies)||[]}async function F(e="forex-factory"){const t=f(e);if(t&&t.categories)return t.categories;await C(!1,e);const a=f(e);return(a==null?void 0:a.categories)||[]}export{C as getAllEvents,F as getCachedCategories,M as getCachedCurrencies,L as getFilteredEvents,q as invalidateCache};
