import{aX as A,ab as R,a0 as T,aA as K,aY as x,aZ as M,ac as N,$ as q,aC as J}from"./index-Dlz0whBs.js";const S={},y="t2t_economic_events_cache",D="t2t_events_cache_metadata",H="1.0.0",k=24,I=new Set,_=(e,t)=>{if((S==null?void 0:S.VITE_DEBUG_CACHE)!=="true")return;const a=`${t||"unknown"}:${e}`;I.has(a)||(I.add(a),console.warn(e))};function w(e="forex-factory"){try{const t=`${D}_${e}`,a=localStorage.getItem(t);if(!a)return null;const r=JSON.parse(a);return r.version!==H?(console.warn("üì¶ Cache version mismatch, invalidating..."),F(e),null):r}catch(t){return console.error("‚ùå Error reading cache metadata:",t),null}}function b(e="forex-factory"){try{const t=`${y}_${e}`,a=localStorage.getItem(t);return a?JSON.parse(a):null}catch(t){return console.error("‚ùå Error reading cached events:",t),null}}function F(e=null){e?(localStorage.removeItem(`${y}_${e}`),localStorage.removeItem(`${D}_${e}`)):(["forex-factory","mql5","fxstreet"].forEach(a=>{localStorage.removeItem(`${y}_${a}`),localStorage.removeItem(`${D}_${a}`)}),localStorage.removeItem(y),localStorage.removeItem(D))}async function L(e="forex-factory"){const t=w(e);if(!t)return!1;const r=Date.now()-t.cachedAt,l=k*60*60*1e3;if(r>l)return console.warn("‚è∞ Cache expired (age-based)"),!1;const f=new Date,s=new Date(f);s.setDate(s.getDate()-14),s.setHours(0,0,0,0);const i=new Date(f);i.setDate(i.getDate()+8),i.setHours(23,59,59,999);const d=b(e);if(!d||d.length===0)return _("‚ö†Ô∏è Cache invalid: no cached events found",e),!1;const c=d.map(o=>o.date).sort((o,n)=>o-n),u=c[0],g=c[c.length-1],C=s.getTime(),h=i.getTime(),m=Math.abs(u-C)/(1e3*60*60*24),E=Math.abs(g-h)/(1e3*60*60*24);if(m>3||E>3)return _(`‚ö†Ô∏è Cache date range outdated: startDiff=${m.toFixed(1)}d, endDiff=${E.toFixed(1)}d`,e),!1;try{const o=await O();return o?!(o>t.lastSyncAt):!0}catch(o){return console.error("‚ùå Error checking sync status:",o),r<=l}}async function O(){try{const e=q(T,"systemJobs","economicEventsCalendarSync"),t=await J(e);if(!t.exists())return null;const r=t.data().lastRun;return r?r.toMillis?r.toMillis():r.seconds*1e3:null}catch(e){return e.code==="permission-denied"?(console.warn("‚ö†Ô∏è Cannot read sync status (not authenticated), using cache age fallback"),null):(console.error("‚ùå Error fetching sync status:",e),null)}}async function Y(e="forex-factory"){try{const t=new Date,a=new Date(t.getTime());a.setDate(a.getDate()-14),a.setHours(0,0,0,0);const r=new Date(t.getTime());r.setDate(r.getDate()+8),r.setHours(23,59,59,999);const l=A.fromDate(a),f=A.fromDate(r),s=R(T,"economicEvents",e,"events"),i=K(s,x("date",">=",l),x("date","<=",f),M("date","asc")),d=await N(i),c=[],u=new Set,g=new Set;d.docs.forEach(o=>{var p,$;const n=o.data();n.currency&&u.add(n.currency),n.category&&g.add(n.category),c.push({id:o.id,name:n.name||n.Name,currency:n.currency||n.Currency,category:n.category||n.Category,date:(p=n.date)!=null&&p.toMillis?n.date.toMillis():(($=n.date)==null?void 0:$.seconds)*1e3||0,actual:n.actual??n.Actual??null,forecast:n.forecast??n.Forecast??null,previous:n.previous??n.Previous??null,outcome:n.outcome||n.Outcome||"",strength:n.strength||n.Strength||"",quality:n.quality||n.Quality||"",projection:n.projection??n.Projection??null,source:e})});const C=`${y}_${e}`;localStorage.setItem(C,JSON.stringify(c));const h=await O()||Date.now(),m={version:H,cachedAt:Date.now(),lastSyncAt:h,eventCount:c.length,currencies:Array.from(u).sort(),categories:Array.from(g).sort(),source:e},E=`${D}_${e}`;return localStorage.setItem(E,JSON.stringify(m)),c}catch(t){return console.error(`‚ùå Error fetching events from ${e}:`,t),[]}}async function v(e=!1,t="forex-factory"){if(!e&&await L(t)){const a=b(t);if(a)return a}return await Y(t)}async function P(e={}){const t=e.source||"forex-factory",a=await v(!1,t),{startDate:r,endDate:l,currencies:f=[],categories:s=[],impacts:i=[]}=e;return a.filter(c=>{var u;if(r&&c.date<r.getTime()||l&&c.date>l.getTime()||f.length>0&&!f.includes(c.currency)||s.length>0&&!s.includes(c.category))return!1;if(i.length>0){const g=((u=c.strength)==null?void 0:u.toLowerCase())||"";if(!i.some(h=>{const m=h.toLowerCase();return g.includes(m)}))return!1}return!0})}async function V(e="forex-factory"){const t=w(e);if(t&&t.currencies)return t.currencies;await v(!1,e);const a=w(e);return(a==null?void 0:a.currencies)||[]}async function B(e="forex-factory"){const t=w(e);if(t&&t.categories)return t.categories;await v(!1,e);const a=w(e);return(a==null?void 0:a.categories)||[]}export{v as getAllEvents,B as getCachedCategories,V as getCachedCurrencies,P as getFilteredEvents,F as invalidateCache};
