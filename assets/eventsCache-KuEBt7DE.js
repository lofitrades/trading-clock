import{M as $,G as N,N as _,R as O,aC as A,S as b,aq as q,J,aF as K}from"./index-C7hvWskH.js";const C={},y="t2t_economic_events_cache",D="t2t_events_cache_metadata",T="1.0.0",F=24,x=new Set,I=(e,t)=>{if((C==null?void 0:C.VITE_DEBUG_CACHE)!=="true")return;const n=`${t||"unknown"}:${e}`;x.has(n)||(x.add(n),console.warn(e))};function E(e="forex-factory"){try{const t=`${D}_${e}`,n=localStorage.getItem(t);if(!n)return null;const r=JSON.parse(n);return r.version!==T?(console.warn("üì¶ Cache version mismatch, invalidating..."),k(e),null):r}catch(t){return console.error("‚ùå Error reading cache metadata:",t),null}}function H(e="forex-factory"){try{const t=`${y}_${e}`,n=localStorage.getItem(t);return n?JSON.parse(n):null}catch(t){return console.error("‚ùå Error reading cached events:",t),null}}function k(e=null){e?(localStorage.removeItem(`${y}_${e}`),localStorage.removeItem(`${D}_${e}`)):(["forex-factory","mql5","fxstreet"].forEach(n=>{localStorage.removeItem(`${y}_${n}`),localStorage.removeItem(`${D}_${n}`)}),localStorage.removeItem(y),localStorage.removeItem(D))}async function L(e="forex-factory"){const t=E(e);if(!t)return!1;const r=Date.now()-t.cachedAt,l=F*60*60*1e3;if(r>l)return console.warn("‚è∞ Cache expired (age-based)"),!1;const u=new Date,s=new Date(u);s.setDate(s.getDate()-14),s.setHours(0,0,0,0);const i=new Date(u);i.setDate(i.getDate()+8),i.setHours(23,59,59,999);const d=H(e);if(!d||d.length===0)return I("‚ö†Ô∏è Cache invalid: no cached events found",e),!1;const c=d.map(o=>o.date).sort((o,a)=>o-a),f=c[0],m=c[c.length-1],w=s.getTime(),h=i.getTime(),g=Math.abs(f-w)/(1e3*60*60*24),S=Math.abs(m-h)/(1e3*60*60*24);if(g>3||S>3)return I(`‚ö†Ô∏è Cache date range outdated: startDiff=${g.toFixed(1)}d, endDiff=${S.toFixed(1)}d`,e),!1;try{const o=await M();return o?!(o>t.lastSyncAt):!0}catch(o){return console.error("‚ùå Error checking sync status:",o),r<=l}}async function M(){try{const e=J(_,"systemJobs","economicEventsCalendarSync"),t=await K(e);if(!t.exists())return null;const r=t.data().lastRun;return r?r.toMillis?r.toMillis():r.seconds*1e3:null}catch(e){return e.code==="permission-denied"?(console.warn("‚ö†Ô∏è Cannot read sync status (not authenticated), using cache age fallback"),null):(console.error("‚ùå Error fetching sync status:",e),null)}}async function j(e="forex-factory"){try{const t=new Date,n=new Date(t.getTime());n.setDate(n.getDate()-14),n.setHours(0,0,0,0);const r=new Date(t.getTime());r.setDate(r.getDate()+8),r.setHours(23,59,59,999);const l=$.fromDate(n),u=$.fromDate(r),s=N(_,"economicEvents",e,"events"),i=O(s,A("date",">=",l),A("date","<=",u),b("date","asc")),d=await q(i),c=[],f=new Set,m=new Set;d.docs.forEach(o=>{var v,p;const a=o.data();a.currency&&f.add(a.currency),a.category&&m.add(a.category),c.push({id:o.id,name:a.name||a.Name,currency:a.currency||a.Currency,category:a.category||a.Category,date:(v=a.date)!=null&&v.toMillis?a.date.toMillis():((p=a.date)==null?void 0:p.seconds)*1e3||0,actual:a.actual??a.Actual??null,forecast:a.forecast??a.Forecast??null,previous:a.previous??a.Previous??null,outcome:a.outcome||a.Outcome||"",strength:a.strength||a.Strength||"",quality:a.quality||a.Quality||"",projection:a.projection??a.Projection??null,source:e})});const w=`${y}_${e}`;localStorage.setItem(w,JSON.stringify(c));const h=await M()||Date.now(),g={version:T,cachedAt:Date.now(),lastSyncAt:h,eventCount:c.length,currencies:Array.from(f).sort(),categories:Array.from(m).sort(),source:e},S=`${D}_${e}`;return localStorage.setItem(S,JSON.stringify(g)),c}catch(t){return console.error(`‚ùå Error fetching events from ${e}:`,t),[]}}async function R(e=!1,t="forex-factory"){if(!e&&await L(t)){const n=H(t);if(n)return n}return await j(t)}async function V(e={}){const t=e.source||"forex-factory",n=await R(!1,t),{startDate:r,endDate:l,currencies:u=[],categories:s=[],impacts:i=[]}=e;return n.filter(c=>{var f;if(r&&c.date<r.getTime()||l&&c.date>l.getTime()||u.length>0&&!u.includes(c.currency)||s.length>0&&!s.includes(c.category))return!1;if(i.length>0){const m=((f=c.strength)==null?void 0:f.toLowerCase())||"";if(!i.some(h=>{const g=h.toLowerCase();return m.includes(g)}))return!1}return!0})}async function Y(e="forex-factory"){const t=E(e);if(t&&t.currencies)return t.currencies;await R(!1,e);const n=E(e);return(n==null?void 0:n.currencies)||[]}export{R as getAllEvents,Y as getCachedCurrencies,V as getFilteredEvents,k as invalidateCache};
