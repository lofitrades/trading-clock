import{c as E,d as h,q as S,o as A,g as w,a as p,b as _}from"./index-Bt-dxDKr.js";const s="t2t_economic_events_cache",i="t2t_events_cache_metadata",f="1.0.0",I=24;function o(){try{const e=localStorage.getItem(i);if(!e)return null;const r=JSON.parse(e);return r.version!==f?(console.log("üì¶ Cache version mismatch, invalidating..."),y(),null):r}catch(e){return console.error("‚ùå Error reading cache metadata:",e),null}}function q(e){try{localStorage.setItem(i,JSON.stringify(e))}catch(r){console.error("‚ùå Error writing cache metadata:",r)}}function O(){try{const e=localStorage.getItem(s);return e?JSON.parse(e):null}catch(e){return console.error("‚ùå Error reading cached events:",e),null}}function R(e){try{localStorage.setItem(s,JSON.stringify(e))}catch(r){console.error("‚ùå Error writing cached events:",r),r.name==="QuotaExceededError"&&(console.warn("‚ö†Ô∏è LocalStorage quota exceeded, clearing cache..."),y())}}function y(){console.log("üóëÔ∏è Invalidating events cache"),localStorage.removeItem(s),localStorage.removeItem(i)}async function x(){const e=o();if(!e)return!1;const a=Date.now()-e.cachedAt,n=I*60*60*1e3;if(a>n)return console.log("‚è∞ Cache expired (age-based)"),!1;try{const c=await m();return c&&c>e.lastSyncAt?(console.log("üîÑ API sync occurred after cache, invalidating"),!1):!0}catch(c){return console.error("‚ùå Error checking sync status:",c),a<=n}}async function m(){try{const e=p(h,"systemJobs","economicEventsCalendarSync"),r=await _(e);if(!r.exists())return null;const n=r.data().lastRun;return n?n.toMillis?n.toMillis():n.seconds*1e3:null}catch(e){return e.code==="permission-denied"?(console.log("‚ö†Ô∏è Cannot read sync status (not authenticated), using cache age fallback"),null):(console.error("‚ùå Error fetching sync status:",e),null)}}async function D(){console.log("üì° Fetching all events from Firestore...");const e=E(h,"economicEventsCalendar"),r=S(e,A("date","asc")),a=await w(r),n=[],c=new Set,l=new Set;a.docs.forEach(u=>{var d,g;const t=u.data();t.currency&&c.add(t.currency),t.category&&l.add(t.category),n.push({id:u.id,name:t.name||t.Name,currency:t.currency||t.Currency,category:t.category||t.Category,date:(d=t.date)!=null&&d.toMillis?t.date.toMillis():((g=t.date)==null?void 0:g.seconds)*1e3||0,actual:t.actual??t.Actual??null,forecast:t.forecast??t.Forecast??null,previous:t.previous??t.Previous??null,outcome:t.outcome||t.Outcome||"",strength:t.strength||t.Strength||"",quality:t.quality||t.Quality||"",projection:t.projection??t.Projection??null,source:t.source||"mql5"})}),R(n);const C=await m()||Date.now();return q({version:f,cachedAt:Date.now(),lastSyncAt:C,eventCount:n.length,currencies:Array.from(c).sort(),categories:Array.from(l).sort()}),console.log(`‚úÖ Cached ${n.length} events`),n}async function v(e=!1){if(!e&&await x()){const r=O();if(r)return console.log(`üì¶ Using cached events (${r.length} events)`),r}return await D()}async function b(){const e=o();if(e&&e.currencies)return e.currencies;await v();const r=o();return(r==null?void 0:r.currencies)||[]}async function H(){const e=o();if(e&&e.categories)return e.categories;await v();const r=o();return(r==null?void 0:r.categories)||[]}export{v as getAllEvents,H as getCachedCategories,b as getCachedCurrencies,y as invalidateCache};
